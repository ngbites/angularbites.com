<!doctype html><html lang="en"><head><meta http-equiv="refresh" content="0;url=https://giancarlobuomprisco.com/angular/intersection-observer-with-angular"><link rel="canonical" href="https://giancarlobuomprisco.com"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png"><link rel="icon" href="/assets/images/favicon.ico"><title>Using the Intersection Observer API with Angular</title><meta name="description" content="This article shows how to build a directive with Angular that uses the Intersection Observer API to check when an element becomes visible on the page"><meta name="author" content="Giancarlo Buomprisco"><meta property="og:title" content="Using the Intersection Observer API with Angular"><meta property="og:description" content="This article shows how to build a directive with Angular that uses the Intersection Observer API to check when an element becomes visible on the page"><meta property="og:locale" content="en"><meta property="og:site_name" content="Angular Bites"><meta property="og:type" content="article"><meta name="twitter:image" property="og:image" content="https://angularbites.com/assets/images/posts/intersection-observer.png"><meta property="twitter:title" content="Using the Intersection Observer API with Angular"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:creator" content="@gc_psk"><meta property="twitter:description" content="This article shows how to build a directive with Angular that uses the Intersection Observer API to check when an element becomes visible on the page"><meta property="og:url" content="https://angularbites.com/intersection-observer-with-angular/"><meta property="article:published_time" content="2020-08-01T00:00:00.000Z"><script type="application/ld+json">{
"description": "This article shows how to build a directive with Angular that uses the Intersection Observer API to check when an element becomes visible on the page",
"author": { "@type": "Person", "name": "Giancarlo Buomprisco" },
"@type": "BlogPosting",
"url": "https://angularbites.com/intersection-observer-with-angular/",
"publisher": {
"@type": "Organization",
"logo": {
"@type": "ImageObject",
"url": "https://angularbites.com/assets/images/logo.png"
},
"name": "Giancarlo Buomprisco"
},
"headline": "Using the Intersection Observer API with Angular",
"datePublished": "2020-08-01T00:00:00.000Z",
"mainEntityOfPage": {
"@type": "WebPage",
"@id": "https://angularbites.com/intersection-observer-with-angular/"
},
"@context": "http://schema.org"
}</script><link href="/assets/styles/main.01b26601bd28e56788b1.css" rel="stylesheet"></head><body><div class="container mx-auto pt-8"><header class="flex items-center"><h1 class="text-4xl my-0"><a class="site-name flex items-center" href="/"><img class="logo" alt="Logo" src="/assets/images/logo.png"></a></h1><div class="flex justify-end flex-grow"><nav class="flex main-navigation"><a class="p-4" href="/contacts.html">Contacts</a></nav></div></header><article class="post pt-4"><header class="mb-8"><h1 class="post-title">Using the Intersection Observer API with Angular</h1><div class="block items-center md:flex justify-center"><div class="user-image flex items-center"><a target="_blank" href="https://twitter.com/@gc_psk" class="flex items-center"><img src="/assets/images/giancarlo.jpeg"> <span class="ml-2 text-gray-600 text-sm">@gc_psk</span> </a><span class="text-gray-600 text-400 ml-1">/ August 1, 2020</span></div><div class="mt-2 md:ml-5 md:mt-0"><a href="/tags/angular" class="tag-item text-xs">angular </a><a href="/tags/performance" class="tag-item text-xs">performance</a></div></div><div class="featured-image mb-8 mt-8 hidden md:block"><img src="/assets/images/posts/intersection-observer.png"></div></header><section class="pb-3"><h2>Intersection Observer: what is it?</h2><p>The <code>Intersection Observer</code> API is a relatively new functionality in web browsers that can allows us to listen to events when an elementâ€™s visibility on the page changes.</p><p>Thanks to Angular's directives, we can create a reusable way to use this API in a declarative and easy way.</p><h3>Use-Cases of the Intersection Observer</h3><p>Why would you want to use this API?</p><ul><li>Improving performance by instantiating only the objects that that are visible to the users</li><li>Improving efficiency by only loading the assets (images, fonts, etc.) used by the visible items</li><li>Implement parallax effects and much, much more</li></ul><p>Personally, I'm very intrigued by the possible performance and efficiency gains enabled by the API - which is what led me to make this directive in the first place.</p><h3>Debouncing</h3><p>The <code>directive</code> we will be using will also enable an important factor not supported by the API: debouncing.</p><p>Imagine your user is scrolling a list very quickly, and your <code>Intersection Observer</code> emits the element as &quot;visible&quot;. Was it, though?</p><p>In my specific scenario, I was loading fonts from Google Fonts when an item was visible for more than 250ms: that tells me the user may have stopped scrolling.</p><h2>Creating a directive that uses an Intersection Observer</h2><p>Let's create this directive, step by step. We will call this directive <code>ObserveVisibilityDirective</code>.</p><h3>Inputs &amp; Outputs</h3><p>First, we define our inputs and outputs:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function"><span class="token maybe-class-name">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> debounceTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
@<span class="token function"><span class="token maybe-class-name">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> threshold <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

@<span class="token function"><span class="token maybe-class-name">Output</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> visible <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">EventEmitter</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HTMLElement</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><code>debounceTime</code>: we've already introduced what debounceTime is, but you should know that by default it is 0, as it is how the API would work</li><li><code>threshold</code>: the threshold property indicates at what percentage the callback should be executed. By default, right away.</li><li><code>visible</code>: we will use the output to notify the parent when an element is visible</li></ul><h3>Creating the Observer</h3><p>First, we save an instance of the Observer on our class:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> observer<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></code></pre><p>Additionally, we also want to create an instance of a Subject which will act as an intermediate messaging bus which we will use to debounce the items' emissions:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> subject$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Subject</span><span class="token operator">&#x3C;</span><span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserverEntry</span><span class="token punctuation">;</span>
  observer<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserver</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>When the component is initialized, we instantiate the Observer.</p><p>The following will:</p><ul><li>instantiate the <code>Observer</code></li><li>for each items called in the callback, we check if the item is &quot;intersecting&quot;</li><li>if yes - then emit the entry via the <code>Subject</code></li></ul><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> <span class="token function">createObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      rootMargin<span class="token operator">:</span> <span class="token string">'0px'</span><span class="token punctuation">,</span>
      threshold<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">threshold</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">isIntersecting</span> <span class="token operator">=</span> <span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserverEntry</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
      entry<span class="token punctuation">.</span><span class="token property-access">isIntersecting</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span><span class="token property-access">intersectionRatio</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntersectionObserver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> observer<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      entries<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>entry <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntersecting</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entry<span class="token punctuation">,</span> observer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre><p>When the view is initialized, we call the method <code>startObservingElements</code>.</p><ul><li>We use the observer to observe the <code>host element</code> of the directive</li><li>We subscribe to the <code>Subject</code> and delay the emission using the <code>debounceTime</code> input's value</li><li>When the Subject emits, we check again if the element is visible using a one-off Intersection Observer promise</li><li>If the element is still visible, then we emit the Output and notify the listeners that the element is visible and has been visible for the specified <code>debounceTime</code> time</li></ul><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> <span class="token function">isVisible</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntersectionObserver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">intersectionRatio</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      observer<span class="token punctuation">.</span><span class="token method function property-access">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    observer<span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">startObservingElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">.</span><span class="token property-access">nativeElement</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">debounceTime</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> entry<span class="token punctuation">,</span> observer <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> target <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token property-access">target</span> <span class="token keyword">as</span> <span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> isStillVisible <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">isVisible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isStillVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">visible</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        observer<span class="token punctuation">.</span><span class="token method function property-access">unobserve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><h3>Using the directive</h3><p>Here's an example of how you could use the directive with a very very long list.</p><p>The <code>visible</code> output will tell you when the item is finally visible for at least 300ms - which could mean the user isn't scrolling anymore. In some cases you may want this number to be lower.</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>ng-container</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>let item of longList<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>app-item</span>
        <span class="token attr-name">observeVisibility</span>
        <span class="token attr-name">[debounceTime]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>
        <span class="token attr-name">(visible)</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onVisible(font)<span class="token punctuation">"</span></span>
    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>app-item</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>ng-container</span><span class="token punctuation">></span></span></code></pre><h3>The full directive's code</h3><p>Here's the full source code of the Directive:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function"><span class="token maybe-class-name">Directive</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[observeVisibility]'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ObserveVisibilityDirective</span></span>
  <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnDestroy</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">OnInit</span><span class="token punctuation">,</span> <span class="token maybe-class-name">AfterViewInit</span> <span class="token punctuation">{</span>
  @<span class="token function"><span class="token maybe-class-name">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> debounceTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  @<span class="token function"><span class="token maybe-class-name">Input</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> threshold <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  @<span class="token function"><span class="token maybe-class-name">Output</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> visible <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">EventEmitter</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HTMLElement</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> observer<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> subject$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Subject</span><span class="token operator">&#x3C;</span><span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserverEntry</span><span class="token punctuation">;</span>
    observer<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserver</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> element<span class="token operator">:</span> <span class="token maybe-class-name">ElementRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">createObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">startObservingElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">.</span><span class="token method function property-access">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span><span class="token punctuation">.</span><span class="token method function property-access">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">isVisible</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntersectionObserver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token property-access">intersectionRatio</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observer<span class="token punctuation">.</span><span class="token method function property-access">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      observer<span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">createObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      rootMargin<span class="token operator">:</span> <span class="token string">'0px'</span><span class="token punctuation">,</span>
      threshold<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">threshold</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token function-variable function">isIntersecting</span> <span class="token operator">=</span> <span class="token punctuation">(</span>entry<span class="token operator">:</span> <span class="token maybe-class-name">IntersectionObserverEntry</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
      entry<span class="token punctuation">.</span><span class="token property-access">isIntersecting</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span><span class="token property-access">intersectionRatio</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntersectionObserver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> observer<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      entries<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>entry <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntersecting</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span><span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entry<span class="token punctuation">,</span> observer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">startObservingElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">observer</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">.</span><span class="token property-access">nativeElement</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">subject$</span>
      <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">debounceTime</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> entry<span class="token punctuation">,</span> observer <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> target <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token property-access">target</span> <span class="token keyword">as</span> <span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> isStillVisible <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">isVisible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isStillVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">visible</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
          observer<span class="token punctuation">.</span><span class="token method function property-access">unobserve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><em>Thank you for reading, I hope you enjoyed this article. If you did, consider follow me on <a href="https://twitter.com/gc_psk">Twitter</a> or sign up to the Newsletter using the form below!</em></p></section><div><script async data-uid="3e3126f064" src="https://thoughtful-inventor-7842.ck.page/3e3126f064/index.js"></script></div><div class="text-sm mt-2">Do you want to report something incorrect? Please open an Issue or a PR on <a class="underline" href="https://github.com/Gbuomprisco/angularbites.com">Github</a></div><footer class="mt-5 pb-5 mb-10"><a class="underline" href="/">Back to home</a></footer></article></div><script async data-uid="da0d688ec8" src="https://thoughtful-inventor-7842.ck.page/da0d688ec8/index.js"></script><link href="https://fonts.googleapis.com/css2?family=Martel:wght@400;700;800&display=swap" rel="stylesheet"></body></html>